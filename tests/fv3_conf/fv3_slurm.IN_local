#!/bin/bash
#SBATCH -e err
#SBATCH -o out
#SBATCH --nodes=@[NODES]
#SBATCH --ntasks-per-node=@[TPN]
#SBATCH --time=@[WLCLK]
#SBATCH --job-name="@[JBNME]"
#SBATCH --exclusive

set -eux
echo -n " $( date +%s )," >  job_timestamp.txt

set +x
MACHINE_ID=local
source ./module-setup.sh
module use $PWD/modulefiles
module load modules.fv3
module list
set -x

ulimit -s unlimited

echo "Model started:  " `date`

export OMPI_ALLOW_RUN_AS_ROOT=1
export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
export ESMF_RUNTIME_PROFILE=ON
export ESMF_RUNTIME_PROFILE_OUTPUT="SUMMARY"

# Avoid job errors because of filesystem synchronization delays
sync && sleep 1

mpirun --oversubscribe --mca btl_tcp_if_include eth0 -np @[TASKS] ./fv3.exe

echo "Model ended:    " `date`
echo -n " $( date +%s )," >> job_timestamp.txt
